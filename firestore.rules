
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para la colección 'users'
    match /users/{userId} {
      // Un usuario puede crear su propio perfil.
      allow create: if request.auth != null && request.auth.uid == userId;
      // Un usuario solo puede leer y actualizar su propio perfil.
      allow read, update: if request.auth != null && request.auth.uid == userId;
      // Nadie puede borrar perfiles (se puede cambiar si es necesario).
      allow delete: if false;
    }

    // Reglas para la colección 'stores'
    match /stores/{storeId} {
      // Cualquiera puede leer la información de las tiendas (para listarlas).
      allow read: if true;
      // Solo un usuario autenticado puede crear una tienda. El ownerId debe ser su UID.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      // Solo el dueño de la tienda puede actualizarla.
      allow update: if request.auth != null && request.auth.uid == resource.data.ownerId;
      // Solo el dueño de la tienda puede eliminarla (por ahora deshabilitado).
      allow delete: if false;

      // Reglas para la subcolección 'products'
      match /products/{productId} {
        // Cualquiera puede leer los productos.
        allow read: if true;
        // El dueño de la tienda (obtenido del documento 'store') puede crear, actualizar y borrar productos.
        allow write: if request.auth != null && request.auth.uid == get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId;
      }
    }

    // Reglas para la colección 'orders'
    match /orders/{orderId} {
        // El comprador, el dueño de la tienda, o un admin pueden leer el pedido.
        allow read: if request.auth != null && 
                       (request.auth.uid == resource.data.userId || 
                        request.auth.uid == get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId ||
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
        // Un usuario autenticado puede crear un pedido para sí mismo.
        allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
        // El dueño de la tienda o un repartidor asignado pueden actualizar el pedido (para cambiar estado, etc.)
        allow update: if request.auth != null && 
                         (request.auth.uid == get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.ownerId ||
                          request.auth.uid == resource.data.deliveryPersonId);
        allow delete: if false;
    }
    
    // Reglas para la colección 'chats' y su subcolección 'messages'
    match /chats/{chatId} {
      // Solo los participantes del chat pueden leer y escribir en él.
      allow read, update, delete: if request.auth != null && request.auth.uid in resource.data.participants;
      allow create: if request.auth != null && request.auth.uid in request.resource.data.participants;

      match /messages/{messageId} {
        // Solo los participantes del chat pueden leer y escribir mensajes.
        allow read, create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow update, delete: if false; // Los mensajes no deben ser editables/borrables por ahora.
      }
    }
  }
}
