/**
 * @file Firestore Security Rules for EncomiendaYA Application
 *
 * @core_philosophy This ruleset enforces a strict ownership model for customer data,
 * while allowing broader access to store, item, and delivery personnel information.
 * Admin privileges are granted based on presence in the /admins collection. Denormalization
 * is used extensively to simplify and secure access control, avoiding costly `get()` calls.
 *
 * @data_structure The Firestore database is structured with top-level collections for
 * admins, stores, delivery personnel, and customers. Customer-owned data (orders, reviews)
 * are nested under the /customers/{customerId} path. Items are nested under /stores/{storeId}.
 *
 * @key_security_decisions
 *   - Listing of stores, items, and delivery personnel is publicly allowed.
 *   - Customer data (profiles, orders, reviews) is strictly controlled by ownership.
 *   - Admin privileges are determined by the presence of a document in the /admins collection.
 *   - No validation of the exact schema of the data.
 *
 * @denormalization_for_authorization
 *   - Each Item includes a `storeId` field, enabling item-level security rules to efficiently
 *     verify the parent store without additional reads.
 *   - Each Review includes `customerId`, `orderId`, and `deliveryPersonnelId` fields,
 *     allowing direct verification of relationships without complex queries.
 *
 * @structural_segregation
 *   - Admin accounts are stored in a separate collection (/admins), making it easy to
 *     manage and verify admin privileges.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {bool} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId - The user ID to compare against the request's auth UID.
     * @return {bool} True if the request is made by the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the request is made by the owner of the resource, ensuring the resource exists.
      * @param {string} userId - The user ID to compare against the request's auth UID.
      * @return {bool} True if the request is made by the existing owner, false otherwise.
      */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin by verifying the existence of their document in the /admins collection.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /**
     * @description Rules for the /admins/{adminId} collection.
     * @path /admins/{adminId}
     * @allow (create) User with matching UID can create their admin document.
     * @deny (create) User tries to create an admin document with a mismatched UID.
     * @allow (get) Any authenticated user can get an admin document.
     * @deny (list) No one can list the admins collection.
     * @allow (update) Only the admin themselves can update their document.
     * @allow (delete) Only the admin themselves can delete their document.
     * @principle Enforces document ownership and admin role management.
     */
    match /admins/{adminId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isOwner(adminId);
      allow update: if isExistingOwner(adminId);
      allow delete: if isExistingOwner(adminId);
    }

    /**
     * @description Rules for the /stores/{storeId} collection.
     * @path /stores/{storeId}
     * @allow (get) Any user can read store information.
     * @allow (list) Any user can list stores.
     * @allow (create) Only an admin can create a store.
     * @allow (update) Only an admin can update a store.
     * @allow (delete) Only an admin can delete a store.
     * @principle Allows public read access but restricts write access to admins.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /stores/{storeId}/items/{itemId} collection.
     * @path /stores/{storeId}/items/{itemId}
     * @allow (get) Any user can read item information.
     * @allow (list) Any user can list items.
     * @allow (create) Only an admin can create an item.
     * @allow (update) Only an admin can update an item.
     * @allow (delete) Only an admin can delete an item.
     * @principle Allows public read access but restricts write access to admins.
     */
    match /stores/{storeId}/items/{itemId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /delivery_personnel/{personnelId} collection.
     * @path /delivery_personnel/{personnelId}
     * @allow (get) Any user can read delivery personnel information.
     * @allow (list) Any user can list delivery personnel.
     * @allow (create) Only an admin can create a delivery personnel.
     * @allow (update) Only an admin can update a delivery personnel.
     * @allow (delete) Only an admin can delete a delivery personnel.
     * @principle Allows public read access but restricts write access to admins.
     */
    match /delivery_personnel/{personnelId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /customers/{customerId} collection.
     * @path /customers/{customerId}
     * @allow (create) User with matching UID can create their customer document.
     * @deny (create) User tries to create a customer document with a mismatched UID.
     * @allow (get) Only the customer themselves can get their document.
     * @allow (list) No one can list the customers collection.
     * @allow (update) Only the customer themselves can update their document.
     * @allow (delete) Only the customer themselves can delete their document.
     * @principle Enforces document ownership for writes, preventing unauthorized modifications.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /customers/{customerId}/orders/{orderId} collection.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (create) Only the customer themselves can create an order.
     * @deny (create) User tries to create an order for another customer.
     * @allow (get) Only the customer themselves can get their order.
     * @allow (list) Only the customer themselves can list their orders.
     * @allow (update) Only the customer themselves can update their order.
     * @allow (delete) Only the customer themselves can delete their order.
     * @principle Enforces document ownership for orders, preventing unauthorized modifications.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /customers/{customerId}/orders/{orderId}/reviews/{reviewId} collection.
     * @path /customers/{customerId}/orders/{orderId}/reviews/{reviewId}
     * @allow (create) Only the customer themselves can create a review for their order.
     * @deny (create) User tries to create a review for another customer's order.
     * @allow (get) Only the customer themselves can get their review.
     * @allow (list) Only the customer themselves can list their reviews.
     * @allow (update) Only the customer themselves can update their review.
     * @allow (delete) Only the customer themselves can delete their review.
     * @principle Enforces document ownership for reviews, preventing unauthorized modifications.
     */
    match /customers/{customerId}/orders/{orderId}/reviews/{reviewId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }
  }
}