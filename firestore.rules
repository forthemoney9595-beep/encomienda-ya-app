/**
 * @fileoverview Firestore Security Rules for the EncomiendaYA application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer data,
 * store-ownership for store data, and admin-only access for admin data.
 * It uses denormalization to ensure efficient and secure data access.
 *
 * Data Structure:
 * - /admins/{adminId}: Stores admin accounts. Admin status is granted by document existence.
 * - /stores/{storeId}: Stores store accounts.
 * - /stores/{storeId}/items/{itemId}: Stores items belonging to a store.
 * - /delivery_personnel/{personnelId}: Stores delivery personnel accounts.
 * - /customers/{customerId}: Stores customer accounts.
 * - /customers/{customerId}/orders/{orderId}: Stores orders placed by a customer.
 * - /customers/{customerId}/orders/{orderId}/reviews/{reviewId}: Stores reviews for orders.
 *
 * Key Security Decisions:
 * - Customers can only access their own orders and reviews.
 * - Stores can only manage their own items.
 * - Admins have full access to admin accounts.
 * - Listing of customer, store, delivery personnel, or admin accounts is disallowed.
 *
 * Denormalization for Authorization:
 * - Items: Includes `storeId` to authorize store-level access.
 * - Reviews: Includes `customerId`, `orderId`, and `deliveryPersonnelId` for access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants admins full access to admin accounts.
     * @path /admins/{adminId}
     * @allow (create) User with matching {adminId} can create their account.
     * @allow (get, list) Only admins can read other admin accounts.
     * @allow (update, delete) Only admins can modify other admin accounts.
     * @deny (create) Non-admins cannot create admin accounts.
     * @deny (get, list) Non-admins cannot read admin accounts.
     * @deny (update, delete) Non-admins cannot modify admin accounts.
     * @principle Enforces admin-only access for managing admin accounts.
     */
    match /admins/{adminId} {
      function isAdmin() {
        return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants read access to stores, but restricts write access.
     * @path /stores/{storeId}
     * @allow (get, list) Anyone can read store information.
     * @deny (create, update, delete) Only admins can create, update, or delete store accounts.
     * @principle Enforces public read access but restricts write access to authorized personnel.
     */
    match /stores/{storeId} {
      function isAdmin() {
        return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants stores ownership of their items.
     * @path /stores/{storeId}/items/{itemId}
     * @allow (get, list) Anyone can read item information.
     * @allow (create) Stores can create new items under their store.
     * @allow (update, delete) Stores can modify their own items.
     * @deny (create) Stores cannot create items under other stores.
     * @deny (update, delete) Stores cannot modify items belonging to other stores.
     * @principle Enforces store-ownership for item management.
     */
    match /stores/{storeId}/items/{itemId} {
      function isAdmin() {
        return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants read access to delivery personnel, but restricts write access.
     * @path /delivery_personnel/{personnelId}
     * @allow (get, list) Anyone can read delivery personnel information.
     * @deny (create, update, delete) Only admins can create, update, or delete delivery personnel accounts.
     * @principle Enforces public read access but restricts write access to authorized personnel.
     */
    match /delivery_personnel/{personnelId} {
       function isAdmin() {
        return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants customers ownership of their accounts.
     * @path /customers/{customerId}
     * @allow (create) User with matching {customerId} can create their account.
     * @allow (get) Customers can read their own account information.
     * @deny (get) Customers cannot read other customer accounts.
     * @deny (list) Listing customers is not allowed.
     * @deny (update, delete) Customers cannot update or delete their accounts.
     * @principle Enforces customer-ownership for account management.
     */
    match /customers/{customerId} {
        function isAdmin() {
        return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants customers ownership of their orders.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (get, list) Customers can read their own order information.
     * @allow (create) Customers can create orders under their account.
     * @deny (create) Customers cannot create orders under other customer accounts.
     * @deny (get, list) Customers cannot read other customer orders.
     * @deny (update, delete) Customers cannot modify or delete their orders.
     * @principle Enforces customer-ownership for order management.
     */
    match /customers/{customerId}/orders/{orderId} {
       function isAdmin() {
        return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Grants customers ownership of their reviews.
     * @path /customers/{customerId}/orders/{orderId}/reviews/{reviewId}
     * @allow (get, list) Anyone can read the reviews.
     * @allow (create) Customers can create reviews for their orders.
     * @deny (create) Customers cannot create reviews under other customer accounts.
     * @deny (update, delete) Customers cannot modify or delete their reviews.
     * @principle Enforces customer-ownership for review creation.
     */
    match /customers/{customerId}/orders/{orderId}/reviews/{reviewId} {
      function isAdmin() {
        return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      }
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}