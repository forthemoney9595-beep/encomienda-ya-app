/**
 * @fileoverview Firestore Security Rules for EncomiendaYA.
 *
 * Core Philosophy:
 * This ruleset employs a hybrid security model, blending user-based ownership with role-based access control for administrative functions.
 *
 * Data Structure:
 * - Stores are at the top level.
 * - Items are nested under stores.
 * - Delivery personnel and customers are also at the top level.
 * - Admins are managed via the `/roles_admin/{uid}` collection, where the existence of a document grants admin privileges.
 * - Orders are nested under customers.
 * - OrderItems are nested under orders.
 * - Reviews are nested under delivery personnel.
 *
 * Key Security Decisions:
 * - Only authenticated users can access most data.
 * - Listing stores, delivery personnel, and customers is not allowed to prevent information disclosure.
 * - Admin privileges are determined by the presence of a document in the `/roles_admin/{uid}` collection, matching the authenticated user's UID.
 * - The rules prioritize secure ownership and prevent unauthorized data modification.
 *
 * Denormalization for Authorization:
 * The data model denormalizes authorization data onto documents to avoid costly `get()` calls in security rules. For example, `items` store the `storeId`, `orders` store the `customerId` and `storeId`, and `reviews` store the `customerId` and `deliveryPersonnelId`. This enables efficient and secure validation of access rights.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     * @path N/A
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource, by comparing the provided userId with the request's auth UID.
     * @path N/A
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource, and that the resource exists.
     * @path N/A
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && getSelf().data != null;
    }

    function getSelf() {
      return get(/databases/$(database)/documents/$(request.path));
    }

    /**
     * @description Checks if the authenticated user has admin privileges by verifying the existence of a document with their UID in the `/roles_admin/{uid}` collection.
     * @path N/A
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Security rules for the `/stores/{storeId}` collection.
     * @path /stores/{storeId}
     */
    match /stores/{storeId} {
      allow get: if isSignedIn();
      allow list: if false; // Prevent listing all stores for privacy.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for the `/stores/{storeId}/items/{itemId}` collection.
     * @path /stores/{storeId}/items/{itemId}
     */
    match /stores/{storeId}/items/{itemId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isAdmin() && request.resource.data.storeId == storeId;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for the `/delivery_personnel/{deliveryPersonnelId}` collection.
     * @path /delivery_personnel/{deliveryPersonnelId}
     */
    match /delivery_personnel/{deliveryPersonnelId} {
      allow get: if isSignedIn();
      allow list: if false; // Prevent listing all delivery personnel for privacy.
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for the `/roles_admin/{uid}` collection.
     * @path /roles_admin/{uid}
     */
    match /roles_admin/{uid} {
      allow get: if isSignedIn() && (isOwner(uid) || isAdmin());
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }

    /**
     * @description Security rules for the `/customers/{customerId}` collection.
     * @path /customers/{customerId}
     */
    match /customers/{customerId} {
      allow get: if isSignedIn() && (isOwner(customerId) || isAdmin());
      allow list: if false; // Prevent listing all customers for privacy.
      allow create: if isSignedIn() && isOwner(customerId);
      allow update: if isSignedIn() && (isOwner(customerId) || isAdmin());
      allow delete: if isSignedIn() && (isOwner(customerId) || isAdmin());
    }

    /**
     * @description Security rules for the `/customers/{customerId}/orders/{orderId}` collection.
     * @path /customers/{customerId}/orders/{orderId}
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isSignedIn() && (isOwner(customerId) || isAdmin());
      allow list: if isSignedIn() && isOwner(customerId);
      allow create: if isSignedIn() && isOwner(customerId) && request.resource.data.customerId == customerId;
      allow update: if isSignedIn() && (isOwner(customerId) || isAdmin());
      allow delete: if isSignedIn() && (isOwner(customerId) || isAdmin());
    }

    /**
     * @description Security rules for the `/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}` collection.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get: if isSignedIn() && (isOwner(customerId) || isAdmin());
      allow list: if isSignedIn() && isOwner(customerId);
      allow create: if isSignedIn() && isOwner(customerId);
      allow update: if isSignedIn() && (isOwner(customerId) || isAdmin());
      allow delete: if isSignedIn() && (isOwner(customerId) || isAdmin());
    }

    /**
     * @description Security rules for the `/delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}` collection.
     * @path /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}
     */
    match /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}