rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows admins to manage admin accounts.
     * @path /admins/{adminId}
     */
    match /admins/{adminId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows anyone to read store information. Only admins can create, update, or delete stores.
     * @path /stores/{storeId}
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows stores to manage their own items.
     * @path /stores/{storeId}/items/{itemId}
     */
    match /stores/{storeId}/items/{itemId} {
      allow get, list: if true;
      allow create: if exists(/databases/$(database)/documents/stores/$(storeId)) && isAdmin();
      allow update: if exists(/databases/$(database)/documents/stores/$(storeId)) && isAdmin();
      allow delete: if exists(/databases/$(database)/documents/stores/$(storeId)) && isAdmin();
    }

    /**
     * @description Allows admins to manage delivery personnel accounts.
     * @path /delivery_personnel/{personnelId}
     */
    match /delivery_personnel/{personnelId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows users to manage their own customer accounts.
     * @path /customers/{customerId}
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if request.auth.uid == customerId;
      allow update: if isOwner(customerId);
      allow delete: if isOwner(customerId);
    }

    /**
     * @description Allows users to manage their own orders.
     * @path /customers/{customerId}/orders/{orderId}
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
      allow list: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
      allow create: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
      allow update: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
      allow delete: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
    }

    /**
     * @description Allows users to manage their own reviews for their orders.
     * @path /customers/{customerId}/orders/{orderId}/reviews/{reviewId}
     */
    match /customers/{customerId}/orders/{orderId}/reviews/{reviewId} {
      allow get: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
      allow list: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
      allow create: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
      allow update: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
      allow delete: if get(/databases/$(database)/documents/customers/$(customerId)).data.id == request.auth.uid;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isAdmin() {
    return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
  }

  function isStoreAdmin(storeId) {
    return get(/databases/$(database)/documents/stores/$(storeId)).data != null && isAdmin(); // Assuming store admins are also admins.  Adjust as necessary.
  }
}