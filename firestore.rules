/**
 * @fileoverview Firestore Security Rules for EncomiendaYA.
 *
 * Core Philosophy:
 * This ruleset prioritizes a secure, owner-based access control model with denormalization for performance and clarity.  It leverages Firebase Authentication to identify users and restricts data access based on user identity and role.  Data validation is limited to authorization-critical fields in the prototyping phase.
 *
 * Data Structure:
 * - /stores/{storeId}: Stores account information.
 * - /stores/{storeId}/items/{itemId}: Items available for sale at each store.
 * - /delivery_personnel/{deliveryPersonnelId}: Delivery personnel accounts.
 * - /roles_admin/{uid}: Admin role assignments.
 * - /customers/{customerId}: Customer accounts.
 * - /customers/{customerId}/orders/{orderId}: Orders placed by customers.
 * - /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}: Items within an order.
 * - /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}: Customer reviews for delivery personnel.
 *
 * Key Security Decisions:
 * - Stores, DeliveryPersonnel and Customers can only be created by backend.
 * - Admin privileges are granted based on the presence of a document in the `/roles_admin/{uid}` collection.
 * - Order and Review documents include denormalized `customerId`, `storeId` and `deliveryPersonnelId` fields to avoid costly `get()` operations in security rules.
 * - Listing of all collections is restricted to owners except `/stores/{storeId}` and `/delivery_personnel/{deliveryPersonnelId}` which are public.
 *
 * Denormalization for Authorization:
 * - /stores/{storeId}/items/{itemId}: Includes `storeId` to allow item-level rules to validate store ownership without additional reads.
 * - /customers/{customerId}/orders/{orderId}: Includes `customerId`, `storeId`, and `deliveryPersonnelId` to allow order-level rules to validate customer and store relationships without additional reads.
 * - /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}: Includes `customerId` and `deliveryPersonnelId` to allow review-level rules to validate customer and delivery personnel relationships without additional reads.
 *
 * Structural Segregation:
 * - Admins: Stored in a separate `/roles_admin/{uid}` collection. The existence of a document for a user grants admin privileges.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} True if the UID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's UID matches the resource's ownerId.
     *              Also ensures that the document exists.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} True if the UID matches and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the authenticated user has admin privileges.
     * @returns {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the top-level /stores/{storeId} collection.
     * @path /stores/{storeId}
     * @allow get, list: if true
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @principle Public read, owner-only writes (requires backend or admin to create/update/delete)
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /stores/{storeId}/items/{itemId} subcollection.
     * @path /stores/{storeId}/items/{itemId}
     * @allow get, list: if true
     * @allow create: if isAdmin()
     * @allow update: if isAdmin()
     * @allow delete: if isAdmin()
     * @principle: Store owners can manage their own items.
     */
    match /stores/{storeId}/items/{itemId} {
        allow get, list: if true;
        allow create: if isAdmin();
        allow update: if isAdmin();
        allow delete: if isAdmin();
    }

    /**
     * @description Rules for the top-level /delivery_personnel/{deliveryPersonnelId} collection.
     * @path /delivery_personnel/{deliveryPersonnelId}
     * @allow get, list: if true
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Public read, owner-only writes (requires backend or admin to create/update/delete)
     */
    match /delivery_personnel/{deliveryPersonnelId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /roles_admin/{uid} collection.
     * @path /roles_admin/{uid}
     * @allow get: if false;
     * @allow list: if false;
     * @allow create: if request.auth.uid == uid;
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Admin role assignment.  Only the user themselves can create the document, and only to assign themselves the role.
     */
    match /roles_admin/{uid} {
      allow get: if false;
      allow list: if false;
      allow create: if request.auth.uid == uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /customers/{customerId} collection.
     * @path /customers/{customerId}
     * @allow get: if isOwner(customerId);
     * @allow list: if false;
     * @allow create: if request.auth.uid == customerId;
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @principle Owner-only access to customer data.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if request.auth.uid == customerId;
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /customers/{customerId}/orders/{orderId} subcollection.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow get: if isOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @allow create: if request.auth.uid == customerId;
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @principle Owner-only access to orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if request.auth.uid == customerId;
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} subcollection.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow get: if isOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @allow create: if request.auth.uid == customerId;
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @principle Owner-only access to order items.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get: if isOwner(customerId);
      allow list: if isOwner(customerId);
      allow create: if request.auth.uid == customerId;
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Rules for the /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId} subcollection.
     * @path /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}
     * @allow get: if true;
     * @allow list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if false;
     * @allow delete: if false;
     * @principle Any signed-in user can create a review. No updates or deletes allowed.
     */
     match /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}