/**
 * @fileoverview Firestore Security Rules for EncomiendaYA.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer data and
 * leverages admin-role checks for administrative functions. Data is denormalized
 * to enable authorization independence and avoid costly `get()` calls.
 *
 * Data Structure:
 * - Admins: /admins/{adminId} - Existence grants admin privileges.
 * - Stores: /stores/{storeId}
 * - Items: /stores/{storeId}/items/{itemId} - storeId is denormalized for independent auth.
 * - Delivery Personnel: /delivery_personnel/{personnelId}
 * - Customers: /customers/{customerId}
 * - Orders: /customers/{customerId}/orders/{orderId}
 * - Reviews: /customers/{customerId}/orders/{orderId}/reviews/{reviewId} - customerId, orderId, deliveryPersonnelId denormalized.
 *
 * Key Security Decisions:
 * - Only authenticated users can access their own customer data.
 * - Admin privileges are granted based on presence in the /admins collection.
 * - Listing of user documents is generally allowed only to the owner.
 * - The schema is not strictly enforced beyond authorization-critical fields.
 *
 * Denormalization for Authorization:
 * - Items denormalize `storeId` to allow store-level authorization without `get()` calls.
 * - Reviews denormalize `customerId`, `orderId`, and `deliveryPersonnelId` to allow
 *   authorization checks based on any of these parameters without extra reads.
 *
 * Structural Segregation:
 * - Private user data (orders, reviews) is stored under the /customers/{customerId}
 *   path, ensuring clear ownership and preventing unauthorized access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing resource.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin by verifying their ID exists in the /admins collection.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /***************** ADMINS *****************/

    /**
     * @description Allows admins to manage their own profiles.
     * @path /admins/{adminId}
     * @allow (get) User with adminId gets their own profile.
     * @allow (create) User with matching auth.uid creates their own profile.
     * @allow (update) Admin updates their own profile.
     * @allow (delete) Admin deletes their own profile.
     * @deny (get) Non-admin tries to access an admin profile.
     * @deny (create) Non-admin attempts to create a new admin profile.
     * @deny (update) Non-admin attempts to update an admin profile.
     * @deny (delete) Non-admin attempts to delete an admin profile.
     * @principle Enforces ownership for admins and restricts access to only admins.
     */
    match /admins/{adminId} {
      allow get: if isSignedIn() && isOwner(adminId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(adminId);
      allow update: if isSignedIn() && isExistingOwner(adminId);
      allow delete: if isSignedIn() && isExistingOwner(adminId);
    }

    /***************** STORES *****************/

    /**
     * @description Allows anyone to read store information, but restricts creation, updates, and deletion.
     * @path /stores/{storeId}
     * @allow (get) Any user can get store information.
     * @allow (list) Any user can list store information.
     * @deny (create) Non-admin attempts to create a store.
     * @deny (update) Non-admin attempts to update a store.
     * @deny (delete) Non-admin attempts to delete a store.
     * @principle Public read, admin-only write access for stores.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /***************** ITEMS *****************/

    /**
     * @description Allows anyone to read item information, but restricts creation, updates, and deletion.
     * @path /stores/{storeId}/items/{itemId}
     * @allow (get) Any user can get item information.
     * @allow (list) Any user can list item information.
     * @deny (create) Non-admin attempts to create an item.
     * @deny (update) Non-admin attempts to update an item.
     * @deny (delete) Non-admin attempts to delete an item.
     * @principle Public read, admin-only write access for items.
     */
    match /stores/{storeId}/items/{itemId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /***************** DELIVERY PERSONNEL *****************/

    /**
     * @description Allows admins to manage delivery personnel accounts.
     * @path /delivery_personnel/{personnelId}
     * @allow (get) Admin gets delivery personnel information.
     * @allow (list) Admin lists delivery personnel.
     * @allow (create) Admin creates delivery personnel.
     * @allow (update) Admin updates delivery personnel.
     * @allow (delete) Admin deletes delivery personnel.
     * @deny (get) Non-admin attempts to get delivery personnel information.
     * @deny (list) Non-admin attempts to list delivery personnel.
     * @deny (create) Non-admin attempts to create delivery personnel.
     * @deny (update) Non-admin attempts to update delivery personnel.
     * @deny (delete) Non-admin attempts to delete delivery personnel.
     * @principle Admin-only access for managing delivery personnel.
     */
    match /delivery_personnel/{personnelId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /***************** CUSTOMERS *****************/

    /**
     * @description Allows customers to manage their own profiles.
     * @path /customers/{customerId}
     * @allow (get) Customer gets their own profile.
     * @allow (create) Customer creates their own profile with matching ID.
     * @allow (update) Customer updates their own profile.
     * @allow (delete) Customer deletes their own profile.
     * @deny (get) Non-owner attempts to get customer profile.
     * @deny (list) Any user attempts to list customers (not allowed).
     * @deny (create) Customer attempts to create a profile with mismatched ID.
     * @deny (update) Non-owner attempts to update customer profile.
     * @deny (delete) Non-owner attempts to delete customer profile.
     * @principle Enforces ownership for customer profiles.
     */
    match /customers/{customerId} {
      allow get: if isSignedIn() && isOwner(customerId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(customerId);
      allow update: if isSignedIn() && isExistingOwner(customerId);
      allow delete: if isSignedIn() && isExistingOwner(customerId);
    }

    /***************** ORDERS *****************/

    /**
     * @description Allows customers to manage their own orders.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (get) Customer gets their own order.
     * @allow (list) Customer lists their own orders.
     * @allow (create) Customer creates their own order under their ID.
     * @allow (update) Customer updates their own order.
     * @allow (delete) Customer deletes their own order.
     * @deny (get) Non-owner attempts to get customer order.
     * @deny (create) Customer attempts to create an order with mismatched ID.
     * @deny (update) Non-owner attempts to update customer order.
     * @deny (delete) Non-owner attempts to delete customer order.
     * @principle Enforces ownership for orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isSignedIn() && isOwner(customerId);
      allow list: if isSignedIn() && isOwner(customerId);
      allow create: if isSignedIn() && isOwner(customerId);
      allow update: if isSignedIn() && isExistingOwner(customerId);
      allow delete: if isSignedIn() && isExistingOwner(customerId);
    }

    /***************** REVIEWS *****************/

    /**
     * @description Allows customers to manage their own reviews for orders.
     * @path /customers/{customerId}/orders/{orderId}/reviews/{reviewId}
     * @allow (get) Customer gets their own review.
     * @allow (list) Customer lists their own reviews.
     * @allow (create) Customer creates their own review under their order.
     * @allow (update) Customer updates their own review.
     * @allow (delete) Customer deletes their own review.
     * @deny (get) Non-owner attempts to get customer review.
     * @deny (create) Customer attempts to create a review with mismatched ID.
     * @deny (update) Non-owner attempts to update customer review.
     * @deny (delete) Non-owner attempts to delete customer review.
     * @principle Enforces ownership for reviews.
     */
    match /customers/{customerId}/orders/{orderId}/reviews/{reviewId} {
      allow get: if isSignedIn() && isOwner(customerId);
      allow list: if isSignedIn() && isOwner(customerId);
      allow create: if isSignedIn() && isOwner(customerId);
      allow update: if isSignedIn() && isExistingOwner(customerId);
      allow delete: if isSignedIn() && isExistingOwner(customerId);
    }
  }
}