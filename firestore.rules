/**
 * @file Firebase Security Rules for EncomiendaYA Firestore Database.
 *
 * @Core Philosophy
 * This ruleset enforces a combination of ownership-based and role-based access control.
 * User-specific data (customers, delivery personnel, stores) is generally protected
 * by ownership, while admins are managed through a dedicated `/roles_admin` collection.
 * Denormalization is heavily used to avoid costly `get()` operations in rules.
 *
 * @Data Structure
 * - `/stores/{storeId}`: Top-level collection for store accounts.
 * - `/stores/{storeId}/items/{itemId}`: Subcollection for items sold by a store.
 * - `/delivery_personnel/{deliveryPersonnelId}`: Top-level collection for delivery personnel accounts.
 * - `/roles_admin/{uid}`: Top-level collection for admin role assignments.  The existence of a document
 *   grants admin privileges.
 * - `/customers/{customerId}`: Top-level collection for customer accounts.
 * - `/customers/{customerId}/orders/{orderId}`: Subcollection for orders placed by a customer.
 * - `/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}`: Subcollection for items within an order.
 * - `/delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}`: Subcollection for customer reviews of delivery personnel.
 *
 * @Key Security Decisions
 * - **No Public Listing**: `list` operations are generally restricted to owners or admins
 *   for user-specific data to prevent unauthorized data discovery.
 * - **Admin Role**: The presence of a document in `/roles_admin/{uid}` grants full admin rights.
 * - **Denormalization**: `storeId`, `customerId`, and `deliveryPersonnelId` are denormalized into child documents
 *   to avoid `get()` calls in security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows stores to manage their own account information.
     * @path /stores/{storeId}
     * @allow (create, update, delete) - Store with ID 'store123' can create/update/delete their own store document when authenticated as 'store123'.
     * @deny (create, update, delete) - User 'customer456' cannot create/update/delete store 'store123' data.
     * @allow (get, list) Any authenticated user can read store information.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete store information.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /stores/{storeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(storeId) {
        return isSignedIn() && request.auth.uid == storeId;
      }

      function isExistingOwner(storeId) {
          return isOwner(storeId) && exists(resource);
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == storeId;
      allow update: if isExistingOwner(storeId);
      allow delete: if isExistingOwner(storeId);
    }

    /**
     * @description Allows stores to manage their items.
     * @path /stores/{storeId}/items/{itemId}
     * @allow (create, update, delete) - Store with ID 'store123' can create/update/delete item 'item789' under their store.
     * @deny (create, update, delete) - User 'customer456' cannot create/update/delete items under store 'store123'.
     * @allow (get, list) Any authenticated user can read items information.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete items.
     * @principle Enforces document ownership for writes, public read access.
     */
    match /stores/{storeId}/items/{itemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isStoreOwner(storeId) {
        return isSignedIn() && request.auth.uid == storeId;
      }

      allow get, list: if true;
      allow create: if isStoreOwner(storeId);
      allow update: if isStoreOwner(storeId);
      allow delete: if isStoreOwner(storeId);
    }

    /**
     * @description Allows delivery personnel to manage their account information.
     * @path /delivery_personnel/{deliveryPersonnelId}
     * @allow (create, update, delete) - Delivery personnel with ID 'delivery123' can create/update/delete their own profile.
     * @deny (create, update, delete) - User 'customer456' cannot create/update/delete delivery personnel 'delivery123' data.
     * @allow (get) Any authenticated user can read delivery personnel information.
     * @allow (list) Only admins can list delivery personnel.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete delivery personnel information.
     * @principle Enforces document ownership for writes, admin-only listing.
     */
    match /delivery_personnel/{deliveryPersonnelId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(deliveryPersonnelId) {
        return isSignedIn() && request.auth.uid == deliveryPersonnelId;
      }

      function isAdmin() {
        return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      function isExistingOwner(deliveryPersonnelId) {
          return isOwner(deliveryPersonnelId) && exists(resource);
      }

      allow get: if true;
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.auth.uid == deliveryPersonnelId;
      allow update: if isExistingOwner(deliveryPersonnelId);
      allow delete: if isExistingOwner(deliveryPersonnelId);
    }

    /**
     * @description Grants admin privileges based on the existence of a document in this collection.
     * @path /roles_admin/{uid}
     * @allow create - Allows creating an admin role document if the authenticated user's UID matches the document ID.
     * @allow get, list, update, delete - Only an admin can manage the admin roles.
     * @deny create - Non-admins cannot create admin roles.
     * @principle Role-based access control for admins.
     */
    match /roles_admin/{uid} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      function isOwner(uid) {
        return isSignedIn() && request.auth.uid == uid;
      }

      allow get, list: if isAdmin();
      allow create: if isOwner(uid);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Allows customers to manage their account information.
     * @path /customers/{customerId}
     * @allow (create, update, delete) - Customer with ID 'customer123' can create/update/delete their own profile.
     * @deny (create, update, delete) - User 'store456' cannot create/update/delete customer 'customer123' data.
     * @allow (get) Any authenticated user can read customer information.
     * @allow (list) Only admins can list customers.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete customer information.
     * @principle Enforces document ownership for writes, admin-only listing.
     */
    match /customers/{customerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(customerId) {
        return isSignedIn() && request.auth.uid == customerId;
      }

      function isAdmin() {
        return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }
        function isExistingOwner(customerId) {
          return isOwner(customerId) && exists(resource);
        }

      allow get: if true;
      allow list: if isAdmin();
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows customers to manage their orders.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (create, update, delete) - Customer 'customer123' can create/update/delete order 'order789' under their account.
     * @deny (create, update, delete) - User 'store456' cannot create/update/delete orders under customer 'customer123'.
     * @allow (get, list) The owner can read their orders.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete orders.
     * @principle Enforces document ownership for writes.
     */
    match /customers/{customerId}/orders/{orderId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isCustomerOwner(customerId) {
        return isSignedIn() && request.auth.uid == customerId;
      }
        function isExistingCustomerOwner(customerId) {
          return isCustomerOwner(customerId) && exists(resource);
        }

      allow get, list: if isCustomerOwner(customerId);
      allow create: if isCustomerOwner(customerId);
      allow update: if isExistingCustomerOwner(customerId);
      allow delete: if isExistingCustomerOwner(customerId);
    }

    /**
     * @description Allows customers to manage the items within their orders.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow (create, update, delete) - Customer 'customer123' can manage items in order 'order789' under their account.
     * @deny (create, update, delete) - User 'store456' cannot manage order items under customer 'customer123'.
     * @allow (get, list) The owner can read their order items.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete order items.
     * @principle Enforces document ownership for writes.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isCustomerOwner(customerId) {
        return isSignedIn() && request.auth.uid == customerId;
      }
        function isExistingCustomerOwner(customerId) {
          return isCustomerOwner(customerId) && exists(resource);
        }

      allow get, list: if isCustomerOwner(customerId);
      allow create: if isCustomerOwner(customerId);
      allow update: if isExistingCustomerOwner(customerId);
      allow delete: if isExistingCustomerOwner(customerId);
    }

    /**
     * @description Allows customers to review delivery personnel.
     * @path /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}
     * @allow (create, update, delete) - Customer 'customer123' can create/update/delete reviews for delivery personnel 'delivery789'.
     * @deny (create, update, delete) - User 'store456' cannot create/update/delete reviews for delivery personnel 'delivery789'.
     * @allow (get, list) The owner can read their reviews.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete reviews.
     * @principle Enforces document ownership for writes.
     */
    match /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId} {
      function isSignedIn() {
        return request.auth != null;
      }

        function isCustomerSignedIn() {
          return isSignedIn() && get(/databases/$(database)/documents/customers/$(request.auth.uid)).data.exists;
        }

      allow get, list: if true;
      allow create: if isCustomerSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}