/**
 * @fileoverview Firestore Security Rules for EncomiendaYA.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for customer data and
 * a role-based model for admin data. Stores and Delivery Personnel are secured
 * for management by authorized users (not defined in the IR). Public read access
 * is not explicitly granted in this initial prototyping phase.
 *
 * Data Structure:
 * - /admins/{adminId}: Admin user accounts.
 * - /stores/{storeId}: Store accounts.
 * - /stores/{storeId}/items/{itemId}: Items offered by stores.
 * - /delivery_personnel/{personnelId}: Delivery personnel accounts.
 * - /customers/{customerId}: Customer accounts.
 * - /customers/{customerId}/orders/{orderId}: Orders placed by customers.
 * - /customers/{customerId}/orders/{orderId}/reviews/{reviewId}: Reviews for orders.
 *
 * Key Security Decisions:
 * - Strict ownership: Customers can only access their own data (orders, reviews).
 * - Admin role: Existence of an admin document grants admin privileges (role not validated).
 * - No public listing: List operations are generally restricted to owners.
 * - Self-creation: Users can create their own customer documents.
 *
 * Denormalization for Authorization:
 * - Item documents include `storeId` to allow item-level rules to quickly verify the parent store.
 * - Review documents include `customerId`, `orderId`, and `deliveryPersonnelId` for authorization independence.
 *
 * Structural Segregation:
 * - Customer data (orders, reviews) is stored under the customer's document to ensure privacy.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to admin user accounts.  Only admins can read/write admin documents.
     * @path /admins/{adminId}
     * @allow (create) User with matching UID can create their own admin document.
     * @allow (get, list, update, delete) Only existing admins can perform these operations.
     * @deny (create) User without matching UID cannot create an admin document.
     * @principle Enforces admin-only access.
     */
    match /admins/{adminId} {
      // Only allow create if the authenticated user's ID matches the adminId.
      allow create: if isSignedIn() && request.auth.uid == adminId;
      allow get, list, update, delete: if isAdmin();
    }

    /**
     * @description Controls access to store accounts.
     * @path /stores/{storeId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Only authorized store managers (not defined in IR) can create, update, or delete store accounts.
     * @deny (create, update, delete) Non-store managers cannot create, update, or delete store accounts.
     * @principle Only store managers can manage store accounts.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Implement store manager role
    }

    /**
     * @description Controls access to items belonging to a specific store.
     * @path /stores/{storeId}/items/{itemId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Only authorized store managers (not defined in IR) can create, update, or delete items.
     * @deny (create, update, delete) Non-store managers cannot create, update, or delete items.
     * @principle Only store managers can manage items for their stores.
     */
    match /stores/{storeId}/items/{itemId} {
      allow get, list: if true;
      allow create, update, delete: if false;  // TODO: Implement store manager role
    }

    /**
     * @description Controls access to delivery personnel accounts.
     * @path /delivery_personnel/{personnelId}
     * @allow (get, list) Public read access.
     * @allow (create, update, delete) Only authorized personnel managers (not defined in IR) can create, update, or delete delivery personnel accounts.
     * @deny (create, update, delete) Non-personnel managers cannot create, update, or delete delivery personnel accounts.
     * @principle Only personnel managers can manage delivery personnel accounts.
     */
    match /delivery_personnel/{personnelId} {
      allow get, list: if true;
      allow create, update, delete: if false;  // TODO: Implement personnel manager role
    }

    /**
     * @description Controls access to customer accounts.  A user can create their own account.
     * @path /customers/{customerId}
     * @allow (create) User with matching UID can create their own customer document.
     * @allow (get, update, delete) Only the customer can read, update, or delete their own account.
     *  @allow list: if false; // Customers should not be able to list all customer accounts.
     * @deny (create) User without matching UID cannot create a customer document.
     * @principle Enforces user-ownership for customer accounts.
     */
    match /customers/{customerId} {
      allow create: if isSignedIn() && request.auth.uid == customerId;
      allow get, update, delete: if isOwner(customerId);
      allow list: if false;
    }

    /**
     * @description Controls access to orders placed by a specific customer.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (create, get, list, update, delete) Only the customer can create, read, update, or delete their own orders.
     * @deny (create, get, update, delete) Other users cannot access customer orders.
     * @principle Enforces user-ownership for orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow create, get, list, update, delete: if isOwner(customerId);
    }

    /**
     * @description Controls access to reviews for a specific order placed by a customer.
     * @path /customers/{customerId}/orders/{orderId}/reviews/{reviewId}
     * @allow (create) Only the customer who placed the order can create a review.
     * @allow (get, update, delete) Only the customer who created the review can read, update, or delete it.
     * @deny (create, get, update, delete) Other users cannot access customer reviews.
     * @principle Enforces user-ownership for reviews.
     */
    match /customers/{customerId}/orders/{orderId}/reviews/{reviewId} {
      allow create, get, update, delete, list: if isOwner(customerId);
    }

    // --- Helper Functions ---

    // Checks if the user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the user is the owner of the resource.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

        // Checks if the user is an existing owner of the resource.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // Checks if the user is an admin (by checking for the existence of their admin document).
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
  }
}