/**
 * @fileoverview Firestore Security Rules for EncomiendaYA.
 *
 * Core Philosophy:
 * This ruleset enforces a strict ownership model for user data, supplemented by admin roles.
 * Data relationships are validated and enforced through path-based rules and denormalized fields.
 *
 * Data Structure:
 * - /admins/{adminId}: Admin user accounts; existence grants admin privileges.
 * - /stores/{storeId}: Store accounts.
 * - /stores/{storeId}/items/{itemId}: Items belonging to stores, denormalized with storeId.
 * - /delivery_personnel/{personnelId}: Delivery personnel accounts.
 * - /customers/{customerId}: Customer accounts.
 * - /customers/{customerId}/orders/{orderId}: Orders placed by customers.
 * - /customers/{customerId}/orders/{orderId}/reviews/{reviewId}: Reviews for orders, denormalized with customerId, orderId, and deliveryPersonnelId.
 *
 * Key Security Decisions:
 * - Admin privileges are granted based on presence in the /admins collection.
 * - Data ownership is enforced for customer-specific data (orders, reviews).
 * - Denormalization is used to avoid costly get() calls in security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants admin privileges based on existence in the /admins collection.
     * @path /admins/{adminId}
     * @allow (get, create, update, delete) if the user's UID matches the adminId.
     * @deny (create) if the user's UID does not match the adminId.
     * @principle Enforces admin-only access based on document ownership.
     */
    match /admins/{adminId} {
      function isAdmin(adminId) {
        return request.auth != null && request.auth.uid == adminId;
      }

      allow get: if isAdmin(adminId);
      allow list: if false;
      allow create: if isAdmin(adminId);
      allow update: if isAdmin(adminId);
      allow delete: if isAdmin(adminId);
    }

    /**
     * @description Allows access to store accounts.
     * @path /stores/{storeId}
     * @allow (get, list) if true.
     * @allow (create, update, delete) if false.
     * @principle Restricts store management.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to items belonging to a specific store.
     * @path /stores/{storeId}/items/{itemId}
     * @allow (get, list) if true.
     * @allow (create, update, delete) if false.
     * @principle Restricts item management to authorized users.
     */
    match /stores/{storeId}/items/{itemId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to delivery personnel accounts.
     * @path /delivery_personnel/{personnelId}
     * @allow (get, list) if true.
     * @allow (create, update, delete) if false.
     * @principle Restricts delivery personnel management.
     */
    match /delivery_personnel/{personnelId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows access to customer accounts.
     * @path /customers/{customerId}
     * @allow (get, list) if true.
     * @allow (create, update, delete) if false.
     * @principle Restricts customer account management.
     */
    match /customers/{customerId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Enforces access control for orders placed by a specific customer.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (get, list) if the user's UID matches the customerId.
     * @allow (create, update, delete) if the user's UID matches the customerId and the order exists.
     * @deny (create) if the order doesn't include the correct customerId.
     * @principle Restricts access to a customer's own orders.
     */
    match /customers/{customerId}/orders/{orderId} {
      function isOwner(customerId) {
        return request.auth != null && request.auth.uid == customerId;
      }
      function isExistingOwner(customerId) {
        return isOwner(customerId) && resource != null;
      }

      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Enforces access control for reviews for a specific order placed by a customer.
     * @path /customers/{customerId}/orders/{orderId}/reviews/{reviewId}
     * @allow (get, list) if the user's UID matches the customerId.
     * @allow (create, update, delete) if the user's UID matches the customerId and the review exists.
     * @deny (create) if the review doesn't include the correct customerId or orderId.
     * @principle Restricts access to reviews associated with a customer's own orders.
     */
    match /customers/{customerId}/orders/{orderId}/reviews/{reviewId} {
      function isOwner(customerId) {
        return request.auth != null && request.auth.uid == customerId;
      }
      function isExistingOwner(customerId) {
        return isOwner(customerId) && resource != null;
      }

      allow get, list: if isOwner(customerId);
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }
  }
}