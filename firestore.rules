/**
 * @file Firebase Security Rules for EncomiendaYA
 *
 * @description
 * This ruleset enforces a role-based access control model with ownership checks to
 * secure data related to stores, delivery personnel, items, orders, customers,
 * and reviews. Admins are managed via a dedicated `roles_admin` collection.
 *
 * @data_structure
 * - `/stores/{storeId}`: Stores account information.
 * - `/stores/{storeId}/items/{itemId}`: Items available for sale at each store.
 * - `/delivery_personnel/{deliveryPersonnelId}`: Delivery personnel accounts.
 * - `/roles_admin/{uid}`: Admin role assignment.
 * - `/customers/{customerId}`: Customer accounts.
 * - `/customers/{customerId}/orders/{orderId}`: Orders placed by customers.
 * - `/customers/{customerId}/orders/{orderId}/order_items/{orderItemId}`: Items within an order.
 * - `/delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}`: Customer reviews for delivery personnel.
 *
 * @key_security_decisions
 * - Admin privileges are granted based on the presence of a document in the `/roles_admin/{uid}` collection.
 * - Data denormalization is used to avoid costly `get()` calls within security rules.
 * - List operations are secured based on path-based ownership or admin roles.
 * - All write operations require authentication.
 *
 * @denormalization_for_authorization
 * - `items` include `storeId` for independent authorization.
 * - `orders` include `customerId`, `storeId`, and `deliveryPersonnelId` for independent authorization.
 * - `reviews` include `customerId` and `deliveryPersonnelId` for independent authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows stores to manage their account information.
     * @path /stores/{storeId}
     * @allow (create, update, delete) if request.auth.uid == storeId
     * @allow (get, list) if true
     * @deny (create, update, delete) if request.auth == null
     * @principle Enforces document ownership for writes. Allows public reads.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == storeId;
      allow update: if isSignedIn() && isExistingOwner(storeId);
      allow delete: if isSignedIn() && isExistingOwner(storeId);
    }

    /**
     * @description Allows stores to manage their items.
     * @path /stores/{storeId}/items/{itemId}
     * @allow (create, update, delete) if request.auth.uid == storeId
     * @allow (get, list) if true
     * @deny (create, update, delete) if request.auth == null
     * @principle Enforces document ownership for writes, public reads.
     */
    match /stores/{storeId}/items/{itemId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == storeId && request.resource.data.storeId == storeId;
      allow update: if isSignedIn() && isExistingItemOwner(storeId);
      allow delete: if isSignedIn() && isExistingItemOwner(storeId);
    }

    /**
     * @description Allows admins to manage delivery personnel accounts.
     * @path /delivery_personnel/{deliveryPersonnelId}
     * @allow (create, update, delete) if isAdmin()
     * @allow (get, list) if isAdmin()
     * @deny (create, update, delete) if !isAdmin()
     * @principle Restricts access to admin users only.
     */
    match /delivery_personnel/{deliveryPersonnelId} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Admin role assignment. Only admins can manage other admins.
     * @path /roles_admin/{uid}
     * @allow (create, update, delete) if isAdmin() || request.auth.uid == uid
     * @allow (get, list) if isAdmin()
     * @deny (create, update, delete) if request.auth == null
     * @principle Restricts access to admin users only.
     */
    match /roles_admin/{uid} {
      allow get, list: if isAdmin();
      allow create: if isAdmin() || request.auth.uid == uid;
      allow update: if isAdmin() || isExistingOwnerForAdmin(uid);
      allow delete: if isAdmin() || isExistingOwnerForAdmin(uid);
    }

    /**
     * @description Allows customers to manage their account information.
     * @path /customers/{customerId}
     * @allow (create, update, delete) if request.auth.uid == customerId
     * @allow (get, list) if request.auth.uid == customerId || isAdmin()
     * @deny (create, update, delete) if request.auth == null
     * @principle Enforces document ownership for writes.
     */
    match /customers/{customerId} {
      allow get: if request.auth.uid == customerId || isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.auth.uid == customerId;
      allow update: if isSignedIn() && isExistingOwner(customerId);
      allow delete: if isSignedIn() && isExistingOwner(customerId);
    }

    /**
     * @description Allows customers to manage their orders.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow (create, update, delete) if request.auth.uid == customerId
     * @allow (get, list) if request.auth.uid == customerId || isAdmin()
     * @deny (create, update, delete) if request.auth == null
     * @principle Enforces document ownership for writes.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if request.auth.uid == customerId || isAdmin();
      allow list: if isOwner(customerId) || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == customerId && request.resource.data.customerId == customerId;
      allow update: if isSignedIn() && isExistingOrderOwner(customerId);
      allow delete: if isSignedIn() && isExistingOrderOwner(customerId);
    }

    /**
     * @description Allows customers to manage their order items.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow (create, update, delete) if request.auth.uid == customerId
     * @allow (get, list) if request.auth.uid == customerId || isAdmin()
     * @deny (create, update, delete) if request.auth == null
     * @principle Enforces document ownership for writes.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get: if request.auth.uid == customerId || isAdmin();
      allow list: if isOwner(customerId) || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == customerId;
      allow update: if isSignedIn() && isExistingOrderItemsOwner(customerId);
      allow delete: if isSignedIn() && isExistingOrderItemsOwner(customerId);
    }

    /**
     * @description Allows customers to create reviews for delivery personnel.
     * @path /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}
     * @allow (create, update, delete) if request.auth.uid == request.resource.data.customerId
     * @allow (get, list) if true
     * @deny (create, update, delete) if request.auth == null
     * @principle Enforces customer ownership for review creation.
     */
    match /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
      allow update: if isSignedIn() && isExistingReviewOwner();
      allow delete: if isSignedIn() && isExistingReviewOwner();
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isExistingOwnerForAdmin(uid) {
      return isOwner(uid) && resource != null;
    }

    function isExistingItemOwner(storeId) {
      return isSignedIn() && isStoreOwner(storeId) && resource != null;
    }

    function isStoreOwner(storeId) {
        return request.auth.uid == storeId;
    }

    function isExistingOrderOwner(customerId) {
      return isSignedIn() && isOwner(customerId) && resource != null;
    }

    function isExistingOrderItemsOwner(customerId) {
      return isSignedIn() && isOwner(customerId) && resource != null;
    }

    function isExistingReviewOwner() {
        return resource != null && request.auth.uid == resource.data.customerId;
    }
  }
}