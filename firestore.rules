/**
 * @fileoverview Firestore Security Rules for EncomiendaYA application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-generated content
 * (orders, reviews) and restricts access to specific roles (admin). It leverages
 * structural segregation for admin role management and denormalization to optimize
 * security and performance, avoiding costly `get()` calls.
 *
 * Data Structure:
 * - /stores/{storeId}: Stores account information.
 * - /stores/{storeId}/items/{itemId}: Items available for sale at each store.
 * - /delivery_personnel/{deliveryPersonnelId}: Delivery personnel accounts.
 * - /roles_admin/{uid}: Admin role assignment.
 * - /customers/{customerId}: Customer accounts.
 * - /customers/{customerId}/orders/{orderId}: Orders placed by customers.
 * - /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}: Items within an order.
 * - /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}: Customer reviews for delivery personnel.
 *
 * Key Security Decisions:
 * - Admins are managed via the `/roles_admin/{uid}` collection. The presence of a
 *   document for a user in this collection grants admin privileges.
 * - Listing of orders is denied to prevent unauthorized access to order information.
 * - All write operations are protected by authorization checks based on user
 *   identity and data ownership.
 * - Read operations are generally open but can be modified in the future to
 *   restrict data access based on roles or ownership.
 *
 * Denormalization for Authorization:
 * - Items include 'storeId' to allow authorization based on the store.
 * - Orders include 'customerId', 'storeId', and 'deliveryPersonnelId' for independent authorization.
 * - Reviews include 'customerId' and 'deliveryPersonnelId' for independent authorization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to store documents. Stores are publicly readable.
     * @path /stores/{storeId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn(); // Store creation requires authentication
     * @allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny create: if !isSignedIn();
     * @deny update: if false;
     * @deny delete: if false;
     * @principle Public read, owner-only writes.
     */
    match /stores/{storeId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows access to item documents within a store. Items are publicly readable but store-owned writable.
     * @path /stores/{storeId}/items/{itemId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn() && request.resource.data.storeId == storeId;
     * @allow update: if isExistingOwner(storeId) && request.resource.data.storeId == resource.data.storeId;
     * @allow delete: if isExistingOwner(storeId);
     * @deny create: if !isSignedIn() || request.resource.data.storeId != storeId;
     * @deny update: if !(isSignedIn() && request.resource.data.storeId == resource.data.storeId);
     * @deny delete: if !isExistingOwner(storeId);
     * @principle Public read, store-owned writes, enforces storeId consistency.
     */
    match /stores/{storeId}/items/{itemId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.storeId == storeId;
      allow update: if isExistingOwner(storeId) && request.resource.data.storeId == resource.data.storeId;
      allow delete: if isExistingOwner(storeId);
    }

    /**
     * @description Allows access to delivery personnel documents. Delivery personnel are publicly readable.
     * @path /delivery_personnel/{deliveryPersonnelId}
     * @allow get, list: if true;
     * @allow create: if false; // TODO: Add admin validation if create is allowed, otherwise deny
     * @allow update: if false; // TODO: Add admin validation if update is allowed, otherwise deny
     * @allow delete: if false; // TODO: Add admin validation if delete is allowed, otherwise deny
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, admin-only writes (currently denied).
     */
    match /delivery_personnel/{deliveryPersonnelId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin validation
    }

    /**
     * @description Allows access to admin role documents. Only accessible to admins.
     * @path /roles_admin/{uid}
     * @allow get: if isAdmin();
     * @allow list: if isAdmin();
     * @allow create: if isAdmin(); // Only admins can assign admin roles
     * @allow update: if isAdmin(); // Only admins can modify admin roles
     * @allow delete: if isAdmin(); // Only admins can revoke admin roles
     * @deny get: if !isAdmin();
     * @deny list: if !isAdmin();
     * @deny create: if !isAdmin();
     * @deny update: if !isAdmin();
     * @deny delete: if !isAdmin();
     * @principle Role-based access control for admin management.
     */
    match /roles_admin/{uid} {
      allow get, list, create, update, delete: if isAdmin();
    }

    /**
     * @description Allows access to customer documents. Customers can only access their own data.
     * @path /customers/{customerId}
     * @allow get: if isOwner(customerId);
     * @allow list: if false; // Listing customers is disallowed
     * @allow create: if isOwner(customerId);
     * @allow update: if isExistingOwner(customerId);
     * @allow delete: if isExistingOwner(customerId);
     * @deny get: if !isOwner(customerId);
     * @deny list: if true;
     * @deny create: if !isOwner(customerId);
     * @deny update: if !isExistingOwner(customerId);
     * @deny delete: if !isExistingOwner(customerId);
     * @principle Owner-only access for customer data, listing disabled.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId);
      allow update: if isExistingOwner(customerId);
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows access to order documents under a specific customer. Customers can only access their own orders. Listing is disabled for security reasons.
     * @path /customers/{customerId}/orders/{orderId}
     * @allow get: if isOwner(customerId);
     * @allow list: if false; // Listing orders is disallowed for security reasons
     * @allow create: if isSignedIn() && request.resource.data.customerId == customerId;
     * @allow update: if isExistingOwner(customerId) && request.resource.data.customerId == resource.data.customerId;
     * @allow delete: if isExistingOwner(customerId);
     * @deny get: if !isOwner(customerId);
     * @deny list: if true;
     * @deny create: if !(isSignedIn() && request.resource.data.customerId == customerId);
     * @deny update: if !(isExistingOwner(customerId) && request.resource.data.customerId == resource.data.customerId);
     * @deny delete: if !isExistingOwner(customerId);
     * @principle Owner-only access for orders, listing disabled, enforces customerId consistency.
     */
    match /customers/{customerId}/orders/{orderId} {
      allow get: if isOwner(customerId);
      allow list: if false; // Listing orders is disallowed for security reasons
      allow create: if isSignedIn() && request.resource.data.customerId == customerId;
      allow update: if isExistingOwner(customerId) && request.resource.data.customerId == resource.data.customerId;
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows access to order item documents within an order. Customers can only access their own order items.
     * @path /customers/{customerId}/orders/{orderId}/order_items/{orderItemId}
     * @allow get: if isOwner(customerId);
     * @allow list: if isOwner(customerId);
     * @allow create: if isSignedIn() && request.resource.data.orderId == orderId;
     * @allow update: if isExistingOwner(customerId) && request.resource.data.orderId == resource.data.orderId;
     * @allow delete: if isExistingOwner(customerId);
     * @deny get: if !isOwner(customerId);
     * @deny list: if !isOwner(customerId);
     * @deny create: if !(isSignedIn() && request.resource.data.orderId == orderId);
     * @deny update: if !(isExistingOwner(customerId) && request.resource.data.orderId == resource.data.orderId);
     * @deny delete: if !isExistingOwner(customerId);
     * @principle Owner-only access for order items, enforces orderId consistency.
     */
    match /customers/{customerId}/orders/{orderId}/order_items/{orderItemId} {
      allow get, list: if isOwner(customerId);
      allow create: if isSignedIn() && request.resource.data.orderId == orderId;
      allow update: if isExistingOwner(customerId) && request.resource.data.orderId == resource.data.orderId;
      allow delete: if isExistingOwner(customerId);
    }

    /**
     * @description Allows access to review documents for delivery personnel. Customers can only access/modify their own reviews.
     * @path /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId}
     * @allow get: if isSignedIn(); // Public get because there is no customerId or deliveryPersonnelId validation
     * @allow list: if isSignedIn();
     * @allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid && request.resource.data.deliveryPersonnelId == deliveryPersonnelId;
     * @allow update: if isExistingOwnerForReview(deliveryPersonnelId) && request.resource.data.customerId == resource.data.customerId && request.resource.data.deliveryPersonnelId == resource.data.deliveryPersonnelId;
     * @allow delete: if isExistingOwnerForReview(deliveryPersonnelId);
     * @deny get: if !isSignedIn();
     * @deny list: if !isSignedIn();
     * @deny create: if !(isSignedIn() && request.resource.data.customerId == request.auth.uid && request.resource.data.deliveryPersonnelId == deliveryPersonnelId);
     * @deny update: if !(isExistingOwnerForReview(deliveryPersonnelId) && request.resource.data.customerId == resource.data.customerId && request.resource.data.deliveryPersonnelId == resource.data.deliveryPersonnelId);
     * @deny delete: if !isExistingOwnerForReview(deliveryPersonnelId);
     * @principle Owner-only access for reviews, enforces customerId and deliveryPersonnelId consistency.
     */
    match /delivery_personnel/{deliveryPersonnelId}/reviews/{reviewId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid && request.resource.data.deliveryPersonnelId == deliveryPersonnelId;
      allow update: if isExistingOwnerForReview(deliveryPersonnelId) && request.resource.data.customerId == resource.data.customerId && request.resource.data.deliveryPersonnelId == resource.data.deliveryPersonnelId;
      allow delete: if isExistingOwnerForReview(deliveryPersonnelId);
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
    }

   function isExistingOwnerForReview(deliveryPersonnelId) {
        return isSignedIn() && request.auth.uid == resource.data.customerId && resource.data.deliveryPersonnelId == deliveryPersonnelId && resource != null;
    }
  }
}